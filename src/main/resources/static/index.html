<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Durak Haritası</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        /* Sayfa ve temel stiller */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 25%;
            background-color: #f4f4f4;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        .sidebar h2 {
            margin-top: 0;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .button-group button {
            flex: 1;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button-group button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .button-group button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        #map {
            width: 75%;
            height: 100vh;
        }

        /* Rota bilgilerini göstereceğimiz alan */
        #routeResult {
            margin-top: 20px;
            /* Eklenen stiller: Dinamik HTML çıktısının okunaklı görünmesi için */
            font-size: 14px;
            line-height: 1.4;
        }

        /* ====== EKLENDİ: Java tarafında kullanılan arka plan sınıfları ====== */
        .blue-bgc {
            background-color: #e3f2fd; /* Mavi tonlu arka plan */
        }
        .orange-bgc {
            background-color: #ffe0b2; /* Turuncu tonlu arka plan */
        }
        .purple-bgc {
            background-color: #f3e5f5; /* Mor tonlu arka plan */
        }

        /* İsteğe bağlı daha fazla stil ekleyebilirsiniz */
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Seçenekler</h2>

            <!-- Yolcu Tipi Seçimi -->
            <div>
                <p>Yolcu tipini seçiniz:</p>
                <div class="button-group">
                    <button id="genelBtn" onclick="selectPassengerType('Genel')">Genel</button>
                    <button id="ogrenciBtn" onclick="selectPassengerType('Ogrenci')">Öğrenci</button>
                    <button id="yasliBtn" onclick="selectPassengerType('Yasli')">Yaşlı</button>
                </div>
            </div>

            <!-- Ödeme Türü Seçimi -->
            <div>
                <p>Ödeme türünü seçiniz:</p>
                <div class="button-group">
                    <button id="nakitBtn" onclick="selectPaymentType('Nakit')">Nakit</button>
                    <button id="kredikartiBtn" onclick="selectPaymentType('KrediKarti')">Kredi Kartı</button>
                    <button id="kentkartBtn" onclick="selectPaymentType('Kentkart')">Kentkart</button>
                </div>
            </div>

            <!-- Başlangıç Noktası Seçimi -->
            <div>
                <p>Başlangıç noktası seçiniz:</p>
                <div class="button-group">
                    <button id="selectStartPointBtn" onclick="enableStartPointSelection()">Başlangıç Noktası Seçiniz</button>
                </div>
            </div>

            <!-- Hedef Konum Seçimi -->
            <div>
                <p>Hedef konum seçiniz:</p>
                <div class="button-group">
                    <button id="selectDestinationPointBtn" onclick="enableDestinationPointSelection()">Hedef Konum Seçiniz</button>
                </div>
            </div>

            <!-- Orijinal Rota Oluştur Butonu -->
            <div>
                <p>Rota oluşturunuz:</p>
                <div class="button-group">
                    <button id="calculateRouteBtn" onclick="calculateRoute()">Rota Oluştur (Konsola)</button>
                </div>
            </div>

            <!-- Yeni Dinamik Rota Butonları -->
            <div>
                <p>Tekli Rota Seçenekleri:</p>
                <div class="button-group">
                    <button onclick="calculateCheapestRoute()">En Uygun Ücretli</button>
                    <button onclick="calculateFastestRoute()">En Uygun Zamanlı</button>
                </div>
                <div class="button-group">
                    <button onclick="calculateShortestRoute()">En Uygun Mesafeli</button>
                    <button onclick="calculateBusRoute()">Sadece Otobüs</button>
                </div>
                <div class="button-group">
                    <button onclick="calculateTramRoute()">Sadece Tramvay</button>
                    <button onclick="calculateTaxiRoute()">Sadece Taksi</button>
                </div>
            </div>

            <!-- Rota Bilgilerini Gösterme Alanı -->
            <div id="routeResult"></div>
        </div>

        <!-- Harita Alanı -->
        <div id="map"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // Harita, durak işaretçileri ve rota çizimleri için kullanılan JavaScript kodları

        const map = L.map('map').setView([40.78259, 29.94628], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const tramIcon = L.icon({ iconUrl: 'tram.png', iconSize: [32, 32] });
        const busIcon = L.icon({ iconUrl: 'bus.png', iconSize: [32, 32] });

        function getRouteCoordinates(lat1, lon1, lat2, lon2) {
            const url = `http://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    }
                    return [[lat1, lon1], [lat2, lon2]];
                })
                .catch(error => {
                    console.error('OSRM rota hatası:', error);
                    return [[lat1, lon1], [lat2, lon2]];
                });
        }

        // /api/stops çağrısı ve durakların haritaya eklenmesi
        fetch('/api/stops')
            .then(response => response.json())
            .then(stopsData => {
                const stopsMap = {};
                stopsData.forEach(stop => {
                    const icon = stop.type === "tram" ? tramIcon : busIcon;
                    const marker = L.marker([stop.lat, stop.lon], { icon: icon }).addTo(map);
                    marker.on('click', function(e) {
                        e.originalEvent.stopPropagation();
                        let stopInfo = `<b>${stop.name}</b><br>`
                                     + `<b>Konum:</b> ${stop.lat}, ${stop.lon}<br>`
                                     + `ID: ${stop.id}<br>`
                                     + `Tip: ${stop.type}<br>`
                                     + `Son Durak: ${stop.sonDurak ? "Evet" : "Hayır"}`;
                        if (stop.nextStops && stop.nextStops.length > 0) {
                            stopInfo += `<br>Sonraki Durak Sayısı: ${stop.nextStops.length}`;
                        }
                        if (stop.transfer) {
                            stopInfo += `<br>Transfer Var`;
                        }
                        marker.unbindPopup();
                        marker.bindPopup(stopInfo, { offset: [0, -30] });
                        marker.openPopup();
                    });
                    stopsMap[stop.id] = stop;
                });
                // Duraklar arası bağlantıları çiz
                stopsData.forEach(stop => {
                    if (stop.nextStops) {
                        stop.nextStops.forEach(ns => {
                            const targetStop = stopsMap[ns.stopId];
                            if (targetStop) {
                                if (stop.type.toLowerCase() === "bus" && targetStop.type.toLowerCase() === "bus") {
                                    getRouteCoordinates(stop.lat, stop.lon, targetStop.lat, targetStop.lon)
                                        .then(routeCoords => {
                                            L.polyline(routeCoords, {
                                                color: 'blue',
                                                dashArray: '5, 5',
                                                weight: 2
                                            }).addTo(map);
                                        });
                                } else if (stop.type.toLowerCase() === "tram" && targetStop.type.toLowerCase() === "tram") {
                                    L.polyline(
                                        [[stop.lat, stop.lon], [targetStop.lat, targetStop.lon]],
                                        { color: 'green', dashArray: '5, 5', weight: 2 }
                                    ).addTo(map);
                                }
                            }
                        });
                    }
                    if (stop.transfer) {
                        const transferStop = stopsMap[stop.transfer.transferStopId];
                        if (transferStop) {
                            L.polyline(
                                [[stop.lat, stop.lon], [transferStop.lat, transferStop.lon]],
                                { color: 'red', dashArray: '5, 5', weight: 2 }
                            ).addTo(map);
                        }
                    }
                });
            })
            .catch(error => console.error('Veri çekme hatası:', error));

        // Yolcu Tipi Seçimi
        function selectPassengerType(type) {
            document.getElementById('genelBtn').disabled = true;
            document.getElementById('ogrenciBtn').disabled = true;
            document.getElementById('yasliBtn').disabled = true;
            document.getElementById(`${type.toLowerCase()}Btn`).style.backgroundColor = '#28a745';
            fetch('/api/selectPassengerType', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ passengerType: type }),
            });
        }

        // Ödeme Türü Seçimi
        function selectPaymentType(type) {
            document.getElementById('nakitBtn').disabled = true;
            document.getElementById('kredikartiBtn').disabled = true;
            document.getElementById('kentkartBtn').disabled = true;
            document.getElementById(`${type.toLowerCase()}Btn`).style.backgroundColor = '#28a745';
            fetch('/api/selectPaymentType', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentType: type }),
            });
        }

        // Başlangıç Noktası Seçimi
        let startPointMarker = null;
        function enableStartPointSelection() {
            map.on('click', onMapClickStart);
            document.getElementById('selectStartPointBtn').disabled = true;
            document.getElementById('selectStartPointBtn').style.backgroundColor = '#28a745';
            alert('Haritada bir noktaya tıklayarak başlangıç noktası seçin.');
        }
        function onMapClickStart(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            if (startPointMarker) { map.removeLayer(startPointMarker); }
            startPointMarker = L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: 'ikon.png',
                    iconSize: [32, 32]
                })
            }).addTo(map);
            fetch('/api/setStartPoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon }),
            });
            map.off('click', onMapClickStart);
        }

        // Hedef Noktası Seçimi
        let destinationPointMarker = null;
        function enableDestinationPointSelection() {
            map.on('click', onMapClickDestination);
            document.getElementById('selectDestinationPointBtn').disabled = true;
            document.getElementById('selectDestinationPointBtn').style.backgroundColor = '#28a745';
            alert('Haritada bir noktaya tıklayarak hedef konum seçin.');
        }
        function onMapClickDestination(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            if (destinationPointMarker) { map.removeLayer(destinationPointMarker); }
            destinationPointMarker = L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: 'ikon.png',
                    iconSize: [32, 32]
                })
            }).addTo(map);
            fetch('/api/setDestinationPoint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: lat, lon: lon }),
            });
            map.off('click', onMapClickDestination);
        }

        // Orijinal Rota Oluştur (Konsola yazan)
        function calculateRoute() {
            fetch('/api/calculateRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                alert(data.message);
            })
            .catch(error => console.error('Rota hesaplama hatası:', error));
        }

        // Dinamik HTML döndüren rota endpoint'leri
        function calculateCheapestRoute() {
            fetch('/api/calculateCheapestRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }
        function calculateFastestRoute() {
            fetch('/api/calculateFastestRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }
        function calculateShortestRoute() {
            fetch('/api/calculateShortestRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }
        function calculateBusRoute() {
            fetch('/api/calculateBusRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }
        function calculateTramRoute() {
            fetch('/api/calculateTramRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }

        function calculateTaxiRoute() {
            fetch('/api/calculateTaxiRoute', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.routeHtml) {
                    document.getElementById('routeResult').innerHTML = data.routeHtml;
                }
            })
            .catch(error => console.error(error));
        }
    </script>
</body>
</html>
